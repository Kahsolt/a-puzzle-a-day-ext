<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>A Puzzle A Day - Extended</title>
  <link rel="stylesheet" href="w3.css"> 
  <script src="solver.js"></script>
  <style>
    .block {
      font-size: 1.2em;
      text-align: center;
      width: 75px;
      height: 75px;
      border: 1px solid skyblue;
    }
  </style>
</head>

<body class="w3-light-grey">
<div class="w3-display-container w3-block">
  <div class="w3-display-topmiddle w3-margin w3-padding-large w3-border w3-center">
    <h3 id="title" class="w3-xxlarge w3-text-blue w3-tooltip w3-hover-sand w3-hover-text-red"> A Puzzle A Day (Ext.) </h3>
    <p id="info" class="w3-text-red w3-animate-opacity"><del> 在浏览器里运行很慢，大约需要1分钟~ </del></p>
    <div class="w3-container">
      <button class="w3-button w3-large w3-pale-yellow w3-hover-lime w3-border-green w3-text-dark-grey" onclick="set_today()"> 今天 </button>
      <input class="w3-button w3-large" id="input" type="date"/>
      <button id="search" class="w3-button w3-large w3-pale-red w3-hover-deep-orange w3-border-red w3-text-dark-grey" onclick="search()"> 求解！ </button>
    </div>
    <div class="w3-panel"> </div>
    <div id="board" class="w3-container">
      <!-- content will be generated by javascript -->
    </div>
    <div class="w3-container">
      <p>Github: <a class="w3-text-blue" href="https://github.com/Kahsolt/a-puzzle-a-day-ext" target="_blank">https://github.com/Kahsolt/a-puzzle-a-day-ext</a> </p>
    </div>
  </div>
</div>

<script>
  const nrow = board_value.length, 
        ncol = board_value[0].length;

  const COLORS = {
    0: 'w3-red',
    1: 'w3-orange',
    2: 'w3-yellow',
    3: 'w3-green',
    4: 'w3-indigo',
    5: 'w3-blue',
    6: 'w3-purple',
    7: 'w3-pink',
    8: 'w3-lime',
    9: 'w3-blue-gray',
  }
  const css_block_class_default = 'block w3-col w3-display-container';
  function setup_board() {
    let board = document.getElementById('board');

    for (let i = 0 ; i < nrow; i++) {
      let row = document.createElement('div');
      row.setAttribute('class', 'w3-row');
      board.appendChild(row);
      for (let j = 0 ; j < ncol; j++) {
        let block = document.createElement('div');
        block.setAttribute('id', 'b_' + i + j);
        block.setAttribute('class', css_block_class_default);
        row.appendChild(block);

        let text = document.createElement('div');
        text.setAttribute('class', 'w3-display-middle');
        let t = '';
        switch (board_type[i][j]) {
          case M: t = MN[board_value[i][j]]; break;
          case D: t = DN[board_value[i][j]]; break;
          case W: t = WN[board_value[i][j]]; break;
        }
        text.innerText = t;
        block.appendChild(text);
      }
    }
  }
  function draw_solution(solut) {
    for (let i = 0 ; i < nrow; i++)
      for (let j = 0 ; j < ncol; j++) {
        let block = document.getElementById('b_' + i + j);
        block.setAttribute('class', css_block_class_default);
        if (solut[i][j] > 0) {
          let k = Number(solut[i][j]) - 1;
          block.setAttribute('class', css_block_class_default + ' ' + COLORS[k]);
        }
      }
  }

  function set_today() {
    let now = new Date();
    y = now.getFullYear();
    m = now.getMonth() + 1;
    d = now.getDate();
    date_str = y + '-' + (m < 10 ? '0': '') + m + '-' + (d < 10 ? '0': '') + d;
    
    document.getElementById('input').value = date_str;
  }
  function get_target() {
    let date_str = document.getElementById('input').value;

    let tgt = new Date(date_str);
    m = tgt.getMonth() + 1;
    d = tgt.getDate();
    w = (tgt.getDay() + 6) % 7 + 1;

    return { month: m, date: d, weekday: w};
  }

  var solver = null;            // generator
  var solver_date_str = null;   // string
  var batch_size = 100000;      // draw UI every N yields
  function search() {
    let date_str = document.getElementById('input').value;

    // if need a new generator
    if (date_str !== solver_date_str) {
      solver_date_str = date_str;
      let R = get_target();
      solver = solve(R.month, R.date, R.weekday, /*by_step*/true);
      solver_na = solve(R.month, R.date, R.weekday, /*by_step*/false);
    }

    // next solution
    let info = document.getElementById('info');
    let savedInfo = info.innerHTML;
    info.innerHTML = "搜索中……请耐心等待……";
    let btn = document.getElementById('search');
    btn.setAttribute('disabled', 'true');
    let ts = Date.now();

    function render() {     
      let step = batch_size;
      while (step-- > 0) {
        R = solver.next().value;
        if (R.is_solution) {
          draw_solution(R.board);
          print_grid(R.board, 'solution');

          info.innerHTML = '<b> 找到当前解共花了 ' + Number((Date.now() - ts) / 1000) + ' 秒 （￣▽￣）b </b>';
          btn.removeAttribute('disabled');
          return;
        }
      }

      draw_solution(R.board);
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);   // start async
  }

  setup_board();
  set_today();
</script>
</body>
</html>
